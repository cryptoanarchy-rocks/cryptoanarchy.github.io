<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>No title</title>
    <link href="/style.css" rel="stylesheet">
</head>
<body>
<h1 id="wireguard-прекрасный-vpn-будущего">WireGuard — прекрасный VPN будущего?</h1>
<p><img src="images/wireguard-1.jpeg" width="600" align="center"/></p>
<p>Наступило время, когда VPN уже не является каким-то экзотическим инструментом бородатых сисадминов. Задачи у пользователей разные, но факт в том, что VPN стал нужен вообще всем.</p>
<p>Проблема текущих VPN решений в том, что их тяжело правильно настроить, дорого обслуживать, а так же в них полно legacy кода сомнительного качества.</p>
<p>Несколько лет назад канадский специалист по информационной безопасности Jason A. Donenfeld решил, что хватит это терпеть, и начал работу над <a href="https://www.wireguard.com/">WireGuard</a>. Сейчас WireGuard готовится к включению в состав ядра Linux, он даже получил похвалы от <a href="https://lists.openwall.net/netdev/2018/08/02/124">Линуса Торвальдса</a> и в <a href="https://www.xda-developers.com/us-senator-pushes-government-use-wireguard-vpn/">американском сенате</a>.</p>
<p>Заявленные преимущества WireGuard над другими VPN решениями:</p>
<ul>
<li>Простой в использовании.</li>
<li>Использует современную криптографию: Noise protocol framework, Curve25519, ChaCha20, Poly1305, BLAKE2, SipHash24, HKDF и т.д.</li>
<li>Компактный читаемый код, проще исследовать на уязвимости.</li>
<li>Высокая производительность.</li>
<li>Четкая и проработанная <a href="https://www.wireguard.com/papers/wireguard.pdf">спецификация</a>.</li>
</ul>
<p>Неужели найдена серебрянная пуля? OpenVPN и IPSec пора закапывать? Я решил с этим разобраться, а заодно сделал <a href="https://github.com/l-n-s/wireguard-install">скрипт для автоматической установки личного VPN сервера</a>.</p>
<h2 id="принципы-работы">Принципы работы</h2>
<p>Принципы работы можно описать примерно так:</p>
<ul>
<li>Создается WireGuard интерфейс, ему назначается приватный ключ и IP адрес. Загружаются настройки других пиров: их публичные ключи, IP адреса и т.д.</li>
<li>Все IP пакеты, приходящие на WireGuard интерфейс инкапсулируются в UDP и <a href="https://www.wireguard.com/protocol/">безопасно доставляются</a> другим пирам.</li>
<li>Клиенты задают публичный IP адрес сервера в настройках. Сервер автоматически узнает внешние адреса клиентов, когда от них приходят корректно аутентифицированные данные.</li>
<li>Сервер может менять публичный IP адрес не прерывая работы. При этом он отошлет оповещение подключенным клиентам и они обновят свою конфигурацию на лету.</li>
<li>Используется концепт маршрутизации <a href="https://www.wireguard.com/#cryptokey-routing">Cryptokey Routing</a>. WireGuard принимает и отправляет пакеты на основании публичного ключа пира. Когда сервер расшифровывает корректно аутентифицированный пакет, проверяется его src поле. Если оно соответствует с конфигурацией <code>allowed-ips</code> аутентифицированного пира, то пакет принимается интерфейсом WireGuard. При отправке исходящего пакета происходит соответственная процедура: берется dst поле пакета и на основании его выбирается соответсвующий пир, пакет подписывается своим ключом, шифруется ключом пира и отправляется на remote endpoint.</li>
</ul>
<p>Вся основная логика WireGuard занимает менее 4 тысяч строк кода, тогда как OpenVPN и IPSec имеют сотни тысяч строк. Для поддержки современных криптоалгоритмов предлагается включить в состав ядра Linux новый криптографический API <a href="https://marc.info/?l=linux-netdev&amp;m=153306437408074&amp;w=2">Zinc</a>. В данный момент идет обсуждение, насколько это удачная идея.</p>
<h2 id="производительность">Производительность</h2>
<p>Максимальное преимущество в производительности (по сравнению с OpenVPN и IPSec) будет заметно на Linux системах, так как там WireGuard реализован в виде модуля ядра. Кроме этого поддерживаются macOS, Android, iOS, FreeBSD и OpenBSD, но в них WireGuard выполняется в userspace со всеми вытекающими последствиями для производительности. Поддержку Windows обещают добавить в ближайшем будущем.</p>
<p>Результаты бенчмарков с <a href="https://www.wireguard.com/performance/">официального сайта</a>:</p>
<div class="figure">
<img src="images/wireguard-2.jpeg" />

</div>
<h2 id="мой-опыт-использования">Мой опыт использования</h2>
<p>Я не эксперт по настройке VPN. Однажды настраивал OpenVPN ручками и это было очень муторно, а IPSec даже и не пытался. Слишком много решений нужно принимать, очень легко выстрелить себе в ногу. Поэтому я всегда пользовался готовыми скриптами для настройки сервера.</p>
<p>Так вот, WireGuard, с моей точки зрения, вообще идеален для пользователя. Все низкоуровневые решения приняты в спецификации, поэтому процесс подготовки типичной VPN инфраструктуры занимает всего несколько минут. Нафакапить в конфигурации практически невозможно.</p>
<p>Процесс установки <a href="https://www.wireguard.com/install/">детально описан</a> на официальном сайте, отдельно хочется отметить отличную <a href="https://openwrt.org/docs/guide-user/network/tunneling_interface_protocols#protocol_wireguard_wireguard_vpn">поддержку OpenWRT</a>.</p>
<p>Генерируются ключи шифрования утилитой <code>wg</code>:</p>
<pre><code>SERVER_PRIVKEY=$( wg genkey )
SERVER_PUBKEY=$( echo $SERVER_PRIVKEY | wg pubkey )
CLIENT_PRIVKEY=$( wg genkey )
CLIENT_PUBKEY=$( echo $CLIENT_PRIVKEY | wg pubkey )</code></pre>
<p>Далее, нужно создать серверный конфиг <code>/etc/wireguard/wg0.conf</code> со следующим содержанием:</p>
<pre><code>[Interface]
Address = 10.9.0.1/24
PrivateKey = $SERVER_PRIVKEY
[Peer]
PublicKey = $CLIENT_PUBKEY
AllowedIPs = 10.9.0.2/32</code></pre>
<p>и поднять туннель скриптом <code>wg-quick</code>:</p>
<pre><code>sudo wg-quick up /etc/wireguard/wg0.conf</code></pre>
<p>В системах с systemd вместо этого можно использовать <code>sudo systemctl start wg-quick@wg0.service</code>.</p>
<p>На клиентской машине, создать конфиг <code>/etc/wireguard/wg0.conf</code>:</p>
<pre><code>[Interface]
PrivateKey = $CLIENT_PRIVKEY
Address = 10.9.0.2/24
[Peer]
PublicKey = $SERVER_PUBKEY
AllowedIPs = 0.0.0.0/0
Endpoint = 1.2.3.4:51820 # Внешний IP сервера
PersistentKeepalive = 25 </code></pre>
<p>И точно так же поднять туннель:</p>
<pre><code>sudo wg-quick up /etc/wireguard/wg0.conf</code></pre>
<p>Осталось настроить NAT на сервере, чтобы клиенты могли выходить в Интерет, и все готово!</p>
<p>Такую простоту использования и компактность кодовой базы удалось достичь за счет отказа от функционала дистрибьюции ключей. Здесь нет сложной системы сертификатов и всего этого корпоративного ужаса, короткие ключи шифрования распространяются примерно как SSH ключи. Но в связи с этим возникает проблема: WireGuard будет не так просто внедрять в некоторых уже существующих сетях.</p>
<p>Из недостатков стоит отметить, что WireGuard не заработает через HTTP proxy, поскольку в качестве транспорта есть только протокол UDP. Возникает вопрос, возможно ли будет обфусцировать протокол? Конечно, это не прямая задача VPN, но для OpenVPN, например, существуют способы маскировки под HTTPS, что помогает жителям тоталитарных стран полноценно пользоваться Интернетом.</p>
<h2 id="выводы">Выводы</h2>
<p>Подводя итог, это очень интересный и перспективный проект, можно уже сейчас использовать его на личных серверах. Какой профит? Высокая производительность на Linux системах, простота настройки и поддержки, компактная и читабельная кодовая база. Однако, бросаться переводить комплексную инфраструктуру на WireGuard еще рано, стоит подождать включение в состав ядра Linux.</p>
<p>Для экономии своего (и вашего) времени я разработал <a href="https://github.com/l-n-s/wireguard-install">автоматический установщик WireGuard</a>. С его помощью можно поднять личный VPN для себя и своих знакомых даже ничего в этом не понимая.</p>
    <hr>
    <p>
        <a href="/">Вернуться на главную</a>
    </p>
</body>
</html>
